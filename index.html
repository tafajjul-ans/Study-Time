<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

<title>Study Time</title>

<style>
:root{
--bg:#0f172a;
--card:#1e293b;
--blue:#3b82f6;
--green:#22c55e;
--red:#ef4444;
--text:#e2e8f0;
}

body{
margin:0;
font-family:Arial;
background:var(--bg);
color:var(--text);
text-align:center;
}

.hidden{display:none;}

button{
padding:10px 15px;
border:none;
border-radius:6px;
cursor:pointer;
font-weight:bold;
}

.primary{background:var(--blue);color:white;}
.success{background:var(--green);color:white;}
.danger{background:var(--red);color:white;}

.card{
background:var(--card);
padding:15px;
margin:10px;
border-radius:8px;
}

input{
padding:8px;
margin:5px;
width:90%;
background:#0b1220;
border:1px solid #334155;
color:white;
border-radius:6px;
}

.clock{font-size:20px;margin:10px;}

.focusTimer{
font-size:60px;
margin-top:40vh;
}
</style>
</head>

<body>

<!-- HOME -->
<div id="homeSection">

<h2>Study Time</h2>
<div class="clock" id="clock"></div>

<div class="card" id="currentSubjectCard">
No active study session
</div>

<button class="success hidden" id="startBtn">START STUDY</button>

<br><br>
<button class="primary" onclick="toggleTimeTable()">Time Table</button>
<button class="primary" onclick="toggleProgress()">Progress</button>

</div>

<!-- FOCUS MODE -->
<div id="focusSection" class="hidden">
<div class="focusTimer" id="countdown">00:00:00</div>
</div>

<!-- TIME TABLE -->
<div id="timeTableSection" class="hidden">
<h3>Time Table</h3>

<input type="text" id="subjectName" placeholder="Subject Name">
<input type="time" id="startTime">
<input type="time" id="endTime">
<button class="primary" onclick="saveSubject()">Save</button>

<div id="subjectList"></div>
<button class="primary" onclick="toggleTimeTable()">Back</button>
</div>

<!-- PROGRESS -->
<div id="progressSection" class="hidden">
<h3>Progress</h3>
<div id="totalStats"></div>
<div id="history"></div>
<button class="danger" onclick="resetProgress()">Reset</button>
<button class="primary" onclick="toggleProgress()">Back</button>
</div>

<script>
let subjects = JSON.parse(localStorage.getItem("subjects")) || [];
let progress = JSON.parse(localStorage.getItem("progress")) || [];
let editingIndex = null;
let countdownInterval;
let activeSession = null;

function saveData(){
localStorage.setItem("subjects",JSON.stringify(subjects));
localStorage.setItem("progress",JSON.stringify(progress));
}

function toggleTimeTable(){
document.getElementById("homeSection").classList.toggle("hidden");
document.getElementById("timeTableSection").classList.toggle("hidden");
renderSubjects();
}

function toggleProgress(){
document.getElementById("homeSection").classList.toggle("hidden");
document.getElementById("progressSection").classList.toggle("hidden");
renderProgress();
}

function saveSubject(){
let name=document.getElementById("subjectName").value;
let start=document.getElementById("startTime").value;
let end=document.getElementById("endTime").value;

if(!name||!start||!end){alert("Fill all fields");return;}

if(editingIndex!==null){
subjects[editingIndex]={name,start,end};
editingIndex=null;
}else{
subjects.push({name,start,end});
}

saveData();
renderSubjects();
}

function renderSubjects(){
let list=document.getElementById("subjectList");
list.innerHTML="";
subjects.forEach((s,i)=>{
list.innerHTML+=`
<div class="card">
<b>${s.name}</b><br>
${s.start} - ${s.end}<br>
<button onclick="editSubject(${i})">Edit</button>
<button onclick="deleteSubject(${i})">Delete</button>
</div>`;
});
}

function editSubject(i){
editingIndex=i;
document.getElementById("subjectName").value=subjects[i].name;
document.getElementById("startTime").value=subjects[i].start;
document.getElementById("endTime").value=subjects[i].end;
}

function deleteSubject(i){
subjects.splice(i,1);
saveData();
renderSubjects();
}

function updateClock(){
let now=new Date();
document.getElementById("clock").innerText=now.toLocaleTimeString();
checkActive();
}

function checkActive(){
let now=new Date();
let current=now.toTimeString().slice(0,5);
let active=null;

subjects.forEach(s=>{
if(current>=s.start && current<s.end){
active=s;
}
});

let card=document.getElementById("currentSubjectCard");
let btn=document.getElementById("startBtn");

if(active){
card.innerHTML=`${active.name}<br>${active.start} - ${active.end}`;
btn.classList.remove("hidden");
btn.onclick=()=>startFocus(active);
}else{
card.innerHTML="No active study session";
btn.classList.add("hidden");
}
}

function startFocus(subject){
let now=new Date();
let end=new Date();
let parts=subject.end.split(":");
end.setHours(parts[0],parts[1],0);

let remaining=(end-now)/1000;

if(remaining<=0){alert("Session Ended");return;}

activeSession={
subject:subject.name,
startTime:now
};

document.getElementById("homeSection").classList.add("hidden");
document.getElementById("focusSection").classList.remove("hidden");

countdownInterval=setInterval(()=>{
if(remaining<=0){
clearInterval(countdownInterval);
finishSession();
return;
}
remaining--;
updateCountdown(remaining);
},1000);
}

function updateCountdown(sec){
let h=Math.floor(sec/3600);
let m=Math.floor((sec%3600)/60);
let s=sec%60;
document.getElementById("countdown").innerText=
String(h).padStart(2,"0")+":"+
String(m).padStart(2,"0")+":"+
String(s).padStart(2,"0");
}

function finishSession(){
let now=new Date();
let duration=Math.floor((now-activeSession.startTime)/60000);

progress.push({
date:new Date().toLocaleDateString(),
subject:activeSession.subject,
duration:duration
});

saveData();

let audio=new Audio("https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3");
audio.play();

alert("Session Completed");

document.getElementById("focusSection").classList.add("hidden");
document.getElementById("homeSection").classList.remove("hidden");
}

function renderProgress(){
let total=progress.reduce((a,b)=>a+b.duration,0);
document.getElementById("totalStats").innerHTML=
"Total Minutes: "+total+"<br>Total Sessions: "+progress.length;

let history=document.getElementById("history");
history.innerHTML="";
progress.forEach(p=>{
history.innerHTML+=`<div class="card">${p.date} - ${p.subject} - ${p.duration} min</div>`;
});
}

function resetProgress(){
progress=[];
saveData();
renderProgress();
}

setInterval(updateClock,1000);
updateClock();
</script>

</body>
</html>
