<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Study Time</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3b82f6">

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js");
}
</script>

<style>
:root{
--bg:#0f172a;
--card:#1e293b;
--blue:#3b82f6;
--red:#ef4444;
--text:#e2e8f0;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);}
.hidden{display:none;}
.statusBar{display:flex;justify-content:space-between;padding:10px;background:#0b1220;}
.content{padding:15px;padding-bottom:100px;}
.card{background:var(--card);padding:15px;border-radius:10px;margin-bottom:15px;}
button{padding:6px 10px;border:none;border-radius:6px;margin:3px;background:var(--blue);color:white;cursor:pointer;}
.danger{background:var(--red);}
input,select{width:100%;padding:6px;margin:4px 0;background:#0b1220;color:white;border:1px solid #334155;border-radius:6px;}
.focusScreen{display:flex;justify-content:center;align-items:center;height:70vh;font-size:50px;}
.navBar{position:fixed;bottom:0;left:0;right:0;background:#0b1220;display:flex;justify-content:space-around;padding:10px;}
.navItem{text-align:center;font-size:12px;color:#94a3b8;cursor:pointer;}
.navItem i{display:block;font-size:18px;}
.activeNav{color:white;}
</style>
</head>

<body>

<div class="statusBar">
<div><i class="fa-solid fa-clock"></i> <span id="clock"></span></div>
<div><i class="fa-solid fa-fire"></i> <span id="streakCount">0</span></div>
</div>

<div class="content">

<div id="homeSection">
<div class="card" id="currentSubjectCard">
<i class="fa-solid fa-book-open"></i> No active session
</div>
<button class="hidden" id="startBtn">
<i class="fa-solid fa-play"></i> START SESSION
</button>
</div>

<div id="focusSection" class="hidden">
<div class="focusScreen">
<i class="fa-solid fa-hourglass-half"></i>
<span id="countdown">00:00:00</span>
</div>
</div>

<div id="timeTableSection" class="hidden">
<div class="card">
<h3><i class="fa-solid fa-calendar-days"></i> Time Table</h3>
<input type="text" id="subjectName" placeholder="Subject">
<input type="time" id="startTime">
<input type="time" id="endTime">
<button onclick="saveSubject()">
<i class="fa-solid fa-floppy-disk"></i> Save
</button>
</div>
<div id="subjectList"></div>
</div>

<div id="progressSection" class="hidden">
<div class="card">
<h3><i class="fa-solid fa-chart-line"></i> Progress</h3>
<div id="history"></div>
</div>
</div>

<div id="settingsSection" class="hidden">

<div class="card">
<h3><i class="fa-solid fa-bell"></i> Start Ringtone</h3>
<select id="startToneSelect" onchange="changeStartTone()">
<option value="male">Study Time (Male)</option>
<option value="female">Study Time (Female)</option>
<option value="custom">Custom Upload</option>
</select>
<input type="file" id="startCustomFile" class="hidden" accept="audio/*" onchange="uploadStartTone()">
<button onclick="previewStart()"><i class="fa-solid fa-play"></i> Preview</button>
</div>

<div class="card">
<h3><i class="fa-solid fa-check-circle"></i> Complete Ringtone</h3>
<select id="completeToneSelect" onchange="changeCompleteTone()">
<option value="male">Complete (Male)</option>
<option value="female">Complete (Female)</option>
<option value="custom">Custom Upload</option>
</select>
<input type="file" id="completeCustomFile" class="hidden" accept="audio/*" onchange="uploadCompleteTone()">
<button onclick="previewComplete()"><i class="fa-solid fa-play"></i> Preview</button>
</div>

</div>

</div>

<div class="navBar">
<div class="navItem activeNav" onclick="showHome(this)">
<i class="fa-solid fa-house"></i>Home
</div>
<div class="navItem" onclick="showTable(this)">
<i class="fa-solid fa-calendar"></i>Table
</div>
<div class="navItem" onclick="showProgress(this)">
<i class="fa-solid fa-chart-simple"></i>Stats
</div>
<div class="navItem" onclick="showSettings(this)">
<i class="fa-solid fa-gear"></i>Settings
</div>
</div>

<script>

/* ================= CORE DATA ================= */
let subjects=JSON.parse(localStorage.getItem("subjects"))||[];
let progress=JSON.parse(localStorage.getItem("progress"))||[];
let streak=JSON.parse(localStorage.getItem("streak"))||0;
let editingIndex=null;
let reminderSentKey=null;
let sessionRunning=false;
let distractionCount=0;
let activeSession=null;
let countdownInterval;

let startTone=localStorage.getItem("startTone")||"male";
let completeTone=localStorage.getItem("completeTone")||"male";
let startCustom=localStorage.getItem("startCustom");
let completeCustom=localStorage.getItem("completeCustom");

document.getElementById("streakCount").innerText=streak;

/* ================= INSTALL BUTTON ================= */
let deferredPrompt;
window.addEventListener("beforeinstallprompt",(e)=>{
e.preventDefault();
deferredPrompt=e;
let btn=document.createElement("button");
btn.textContent="Install App";
btn.style.position="fixed";
btn.style.top="60px";
btn.style.right="20px";
btn.style.zIndex="999";
document.body.appendChild(btn);
btn.onclick=async()=>{
btn.remove();
deferredPrompt.prompt();
await deferredPrompt.userChoice;
};
});

/* ================= CLOCK ================= */
setInterval(()=>{
document.getElementById("clock").innerText=new Date().toLocaleTimeString();
checkActive();
},1000);

/* ================= RINGTONE ================= */
function getTone(type){
if(type==="start"){
if(startTone==="custom" && startCustom) return startCustom;
return startTone==="male"?"ring-start-1.mp3":"ring-start-2.mp3";
}
if(type==="complete"){
if(completeTone==="custom" && completeCustom) return completeCustom;
return completeTone==="male"?"ring-complete-1.mp3":"ring-complete-2.mp3";
}
}

function playAlarm(type){
let audio=new Audio(getTone(type));
let count=0;
function loop(){
if(count>=3) return;
audio.currentTime=0;
audio.play();
count++;
}
audio.addEventListener("ended",loop);
loop();
}

/* ================= NOTIFICATION ================= */
async function notify(title,body){
if(Notification.permission!=="granted"){
await Notification.requestPermission();
}
let reg=await navigator.serviceWorker.getRegistration();
if(reg) reg.showNotification(title,{body});
}

/* ================= ACTIVE CHECK ================= */
function checkActive(){
let now=new Date().toTimeString().slice(0,5);
let active=null;
subjects.forEach(s=>{
if(now>=s.start && now<s.end) active=s;
});
let card=document.getElementById("currentSubjectCard");
let btn=document.getElementById("startBtn");

if(active){
card.innerHTML=`<i class="fa-solid fa-book"></i> <b>${active.name}</b><br>${active.start}-${active.end}`;
btn.classList.remove("hidden");
btn.onclick=()=>startSession(active);
let key=active.name+"-"+active.start;
if(reminderSentKey!==key){
reminderSentKey=key;
notify("Study Time",active.name+" ready");
playAlarm("start");
}
}else{
card.innerHTML=`<i class="fa-solid fa-book-open"></i> No active session`;
btn.classList.add("hidden");
reminderSentKey=null;
}
}

/* ================= SESSION ================= */
function startSession(subject){
let now=new Date();
let end=new Date();
let p=subject.end.split(":");
end.setHours(p[0],p[1],0);
let remaining=(end-now)/1000;
if(remaining<=0) return;

activeSession={subject:subject.name,startTime:now};
sessionRunning=true;
distractionCount=0;

hideAll();
document.getElementById("focusSection").classList.remove("hidden");

countdownInterval=setInterval(()=>{
if(remaining<=0){
clearInterval(countdownInterval);
finishSession();
return;
}
remaining--;
updateCountdown(remaining);
},1000);
}

function updateCountdown(sec){
let h=Math.floor(sec/3600);
let m=Math.floor((sec%3600)/60);
let s=sec%60;
document.getElementById("countdown").innerText=
String(h).padStart(2,"0")+":"+
String(m).padStart(2,"0")+":"+
String(s).padStart(2,"0");
}

function finishSession(){
progress.push({
date:new Date().toLocaleDateString(),
subject:activeSession.subject,
distractions:distractionCount
});
localStorage.setItem("progress",JSON.stringify(progress));
streak++;
localStorage.setItem("streak",streak);
document.getElementById("streakCount").innerText=streak;
sessionRunning=false;
notify("Session Complete","Take a break");
playAlarm("complete");
showHome();
}

document.addEventListener("visibilitychange",()=>{
if(document.hidden && sessionRunning) distractionCount++;
});

/* ================= TIMETABLE CRUD ================= */
function saveSubject(){
let name=document.getElementById("subjectName").value;
let start=document.getElementById("startTime").value;
let end=document.getElementById("endTime").value;
if(!name||!start||!end) return;
if(editingIndex!==null){
subjects[editingIndex]={name,start,end};
editingIndex=null;
}else{
subjects.push({name,start,end});
}
localStorage.setItem("subjects",JSON.stringify(subjects));
clearForm();
renderSubjects();
}
function editSubject(i){
editingIndex=i;
document.getElementById("subjectName").value=subjects[i].name;
document.getElementById("startTime").value=subjects[i].start;
document.getElementById("endTime").value=subjects[i].end;
}
function deleteSubject(i){
subjects.splice(i,1);
localStorage.setItem("subjects",JSON.stringify(subjects));
renderSubjects();
}
function clearForm(){
document.getElementById("subjectName").value="";
document.getElementById("startTime").value="";
document.getElementById("endTime").value="";
}
function renderSubjects(){
let list=document.getElementById("subjectList");
list.innerHTML="";
subjects.forEach((s,i)=>{
list.innerHTML+=`
<div class="card">
<i class="fa-solid fa-book"></i> <b>${s.name}</b><br>${s.start}-${s.end}<br>
<button onclick="editSubject(${i})"><i class="fa-solid fa-pen"></i></button>
<button class="danger" onclick="deleteSubject(${i})"><i class="fa-solid fa-trash"></i></button>
</div>`;
});
}
renderSubjects();

/* ================= SETTINGS ================= */
function changeStartTone(){
startTone=document.getElementById("startToneSelect").value;
localStorage.setItem("startTone",startTone);
document.getElementById("startCustomFile").classList.toggle("hidden",startTone!=="custom");
}
function changeCompleteTone(){
completeTone=document.getElementById("completeToneSelect").value;
localStorage.setItem("completeTone",completeTone);
document.getElementById("completeCustomFile").classList.toggle("hidden",completeTone!=="custom");
}
function uploadStartTone(){
let file=document.getElementById("startCustomFile").files[0];
let reader=new FileReader();
reader.onload=e=>{
startCustom=e.target.result;
localStorage.setItem("startCustom",startCustom);
};
reader.readAsDataURL(file);
}
function uploadCompleteTone(){
let file=document.getElementById("completeCustomFile").files[0];
let reader=new FileReader();
reader.onload=e=>{
completeCustom=e.target.result;
localStorage.setItem("completeCustom",completeCustom);
};
reader.readAsDataURL(file);
}
function previewStart(){playAlarm("start");}
function previewComplete(){playAlarm("complete");}

/* ================= NAV ================= */
function setActiveNav(el){
document.querySelectorAll(".navItem").forEach(n=>n.classList.remove("activeNav"));
if(el) el.classList.add("activeNav");
}
function hideAll(){
document.getElementById("homeSection").classList.add("hidden");
document.getElementById("timeTableSection").classList.add("hidden");
document.getElementById("progressSection").classList.add("hidden");
document.getElementById("settingsSection").classList.add("hidden");
document.getElementById("focusSection").classList.add("hidden");
}
function showHome(el){if(el)setActiveNav(el);hideAll();document.getElementById("homeSection").classList.remove("hidden");}
function showTable(el){setActiveNav(el);hideAll();document.getElementById("timeTableSection").classList.remove("hidden");}
function showProgress(el){setActiveNav(el);hideAll();renderProgress();document.getElementById("progressSection").classList.remove("hidden");}
function showSettings(el){setActiveNav(el);hideAll();document.getElementById("settingsSection").classList.remove("hidden");}
function renderProgress(){
let history=document.getElementById("history");
history.innerHTML="";
progress.forEach(p=>{
history.innerHTML+=`<div class="card">${p.date}<br>${p.subject}<br>Distractions:${p.distractions}</div>`;
});
}

</script>
</body>
</html>
